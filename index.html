<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Provides functions and classes to help create Species Distribution 
  Models (SDMs) within the {tidymodels} framework. Provides new {parsnip} models,
  new {recipes} steps, and {yardstick} metrics. This package provides access to the 
  powerful {tidymodels} ecosystem for SDMs, especially the package {spatialsample} 
  for spatially aware cross validation and model evaluation, as well as opening 
  up all classification models implemented in {parsnip} for presence-only SDMs,
  using the pseudo-absence approach.">
<title>Sprecies Distribution Modelling with Tidymodels • tidysdm</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Sprecies Distribution Modelling with Tidymodels">
<meta property="og:description" content="Provides functions and classes to help create Species Distribution 
  Models (SDMs) within the {tidymodels} framework. Provides new {parsnip} models,
  new {recipes} steps, and {yardstick} metrics. This package provides access to the 
  powerful {tidymodels} ecosystem for SDMs, especially the package {spatialsample} 
  for spatially aware cross validation and model evaluation, as well as opening 
  up all classification models implemented in {parsnip} for presence-only SDMs,
  using the pseudo-absence approach.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">tidysdm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/getting_started.html">Getting Started with {tidysdm}</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="tidysdm">tidysdm<a class="anchor" aria-label="anchor" href="#tidysdm"></a>
</h1></div>
<!-- badges: start -->

<p><code>tidysdm</code> is a package to make it easy to fit Species Distribution Models in a <code>tidymodels</code> framework.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the development version of tidysdm from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"rdinnager/tidysdm"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rdinnager.github.io/tidysdm/">tidysdm</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: parsnip</span></span>
<span><span class="co">#&gt; Loading required package: recipes</span></span>
<span><span class="co">#&gt; Loading required package: dplyr</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'recipes'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     step</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">112233</span><span class="op">)</span></span></code></pre></div>
<p>We will use data from the <code>ENMTools</code> package to demonstrate how <code>tidysdm</code> works.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ENMTools</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: raster</span></span>
<span><span class="co">#&gt; Loading required package: sp</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'raster'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     select</span></span>
<span><span class="co">#&gt; Loading required package: dismo</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── Attaching packages</span></span>
<span><span class="co">#&gt; ───────────────────────────────────────</span></span>
<span><span class="co">#&gt; tidyverse 1.3.2 ──</span></span>
<span><span class="co">#&gt; ✔ ggplot2 3.3.6     ✔ purrr   0.3.5</span></span>
<span><span class="co">#&gt; ✔ tibble  3.1.8     ✔ stringr 1.4.1</span></span>
<span><span class="co">#&gt; ✔ tidyr   1.2.1     ✔ forcats 0.5.2</span></span>
<span><span class="co">#&gt; ✔ readr   2.1.3     </span></span>
<span><span class="co">#&gt; ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">#&gt; ✖ tidyr::extract() masks raster::extract()</span></span>
<span><span class="co">#&gt; ✖ dplyr::filter()  masks stats::filter()</span></span>
<span><span class="co">#&gt; ✖ stringr::fixed() masks recipes::fixed()</span></span>
<span><span class="co">#&gt; ✖ dplyr::lag()     masks stats::lag()</span></span>
<span><span class="co">#&gt; ✖ raster::select() masks dplyr::select()</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── Attaching packages ────────────────────────────────────── tidymodels 1.0.0 ──</span></span>
<span><span class="co">#&gt; ✔ broom        1.0.1     ✔ tune         1.0.1</span></span>
<span><span class="co">#&gt; ✔ dials        1.0.0     ✔ workflows    1.1.0</span></span>
<span><span class="co">#&gt; ✔ infer        1.0.3     ✔ workflowsets 1.0.0</span></span>
<span><span class="co">#&gt; ✔ modeldata    1.0.1     ✔ yardstick    1.1.0</span></span>
<span><span class="co">#&gt; ✔ rsample      1.1.0     </span></span>
<span><span class="co">#&gt; ── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──</span></span>
<span><span class="co">#&gt; ✖ scales::discard()  masks purrr::discard()</span></span>
<span><span class="co">#&gt; ✖ tidyr::extract()   masks raster::extract()</span></span>
<span><span class="co">#&gt; ✖ dplyr::filter()    masks stats::filter()</span></span>
<span><span class="co">#&gt; ✖ stringr::fixed()   masks recipes::fixed()</span></span>
<span><span class="co">#&gt; ✖ dplyr::lag()       masks stats::lag()</span></span>
<span><span class="co">#&gt; ✖ raster::select()   masks dplyr::select()</span></span>
<span><span class="co">#&gt; ✖ yardstick::spec()  masks readr::spec()</span></span>
<span><span class="co">#&gt; ✖ recipes::step()    masks stats::step()</span></span>
<span><span class="co">#&gt; ✖ dials::threshold() masks dismo::threshold()</span></span>
<span><span class="co">#&gt; ✖ raster::update()   masks recipes::update(), stats::update()</span></span>
<span><span class="co">#&gt; • Use tidymodels_prefer() to resolve common conflicts.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/spatialsample" class="external-link">spatialsample</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"iberolacerta.clade"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"euro.worldclim"</span><span class="op">)</span></span>
<span><span class="va">monticola</span> <span class="op">&lt;-</span> <span class="va">iberolacerta.clade</span><span class="op">$</span><span class="va">species</span><span class="op">$</span><span class="va">monticola</span></span></code></pre></div>
<p>We start by generating a {tidymodels} compatable <code>sf</code> object for the species we want to model.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sdm_data.html">sdm_data</a></span><span class="op">(</span><span class="va">monticola</span><span class="op">$</span><span class="va">presence.points</span>,</span>
<span>                bg <span class="op">=</span> <span class="va">monticola</span><span class="op">$</span><span class="va">range</span>,</span>
<span>                n <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>                coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Longitude"</span>,</span>
<span>                           <span class="st">"Latitude"</span><span class="op">)</span>,</span>
<span>                crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span></span>
<span><span class="co">#&gt; Simple feature collection with 5260 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -9.31549 ymin: 39.83402 xmax: 0.6627441 ymax: 43.8299</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; First 10 features:</span></span>
<span><span class="co">#&gt;    present pnt_origin                       pnts</span></span>
<span><span class="co">#&gt; 1  present       data POINT (-5.171215 43.06957)</span></span>
<span><span class="co">#&gt; 2  present       data POINT (-6.036635 43.02531)</span></span>
<span><span class="co">#&gt; 3  present       data POINT (-7.679727 40.38852)</span></span>
<span><span class="co">#&gt; 4  present       data POINT (-7.790437 40.30959)</span></span>
<span><span class="co">#&gt; 5  present       data  POINT (-7.47334 43.78935)</span></span>
<span><span class="co">#&gt; 6  present       data  POINT (-6.575039 42.9107)</span></span>
<span><span class="co">#&gt; 7  present       data POINT (-5.132756 43.49572)</span></span>
<span><span class="co">#&gt; 8  present       data POINT (-7.787378 40.39362)</span></span>
<span><span class="co">#&gt; 9  present       data  POINT (-4.941888 43.3531)</span></span>
<span><span class="co">#&gt; 10 present       data  POINT (-7.621731 40.3417)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>       <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">present</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">present</span><span class="op">)</span>, </span>
<span>     pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-bg_convert-1.png" width="100%"></p>
<p>Now we can use the <a href="https://github.com/tidymodels/spatialsample" class="external-link">spatialsample</a> package to create spatial cross validation folds! We will first create a regular cross validation fold object for comparison. Note that this can take awhile because a spatial distance is calculated between all points! We are working on a faster method for pseudo-absence data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## regular CV</span></span>
<span><span class="va">cv_folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">dat</span>, <span class="fl">9</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## spatial CV</span></span>
<span><span class="va">cv_folds_spat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://spatialsample.tidymodels.org/reference/spatial_block_cv.html" class="external-link">spatial_block_cv</a></span><span class="op">(</span><span class="va">dat</span>, method <span class="op">=</span> <span class="st">"snake"</span>,</span>
<span>                             n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>                             v <span class="op">=</span> <span class="fl">9</span>,</span>
<span>                             buffer <span class="op">=</span> <span class="fl">50000</span><span class="op">)</span></span>
<span><span class="va">cv_folds_spat</span></span>
<span><span class="co">#&gt; #  9-fold spatial block cross-validation </span></span>
<span><span class="co">#&gt; # A tibble: 9 × 2</span></span>
<span><span class="co">#&gt;   splits              id   </span></span>
<span><span class="co">#&gt;   &lt;list&gt;              &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 &lt;split [3098/902]&gt;  Fold1</span></span>
<span><span class="co">#&gt; 2 &lt;split [4056/427]&gt;  Fold2</span></span>
<span><span class="co">#&gt; 3 &lt;split [3923/761]&gt;  Fold3</span></span>
<span><span class="co">#&gt; 4 &lt;split [4175/517]&gt;  Fold4</span></span>
<span><span class="co">#&gt; 5 &lt;split [4408/375]&gt;  Fold5</span></span>
<span><span class="co">#&gt; 6 &lt;split [4501/71]&gt;   Fold6</span></span>
<span><span class="co">#&gt; 7 &lt;split [4293/210]&gt;  Fold7</span></span>
<span><span class="co">#&gt; 8 &lt;split [3346/789]&gt;  Fold8</span></span>
<span><span class="co">#&gt; 9 &lt;split [3246/1207]&gt; Fold9</span></span>
<span></span>
<span><span class="co">## look at the spatial folds</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">cv_folds_spat</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-spatial_block_cv-1.png" width="100%"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">cv_folds_spat</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-spatial_block_cv-2.png" width="100%"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">cv_folds_spat</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">8</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-spatial_block_cv-3.png" width="100%"></p>
<p>Let’s create a recipe to apply some common data processing steps to prepare for SDM fitting. We start with <code>step_add_env_vars()</code>, which is a <a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a> function. The rest are standard steps from the <a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a> package. <code><a href="https://recipes.tidymodels.org/reference/step_impute_median.html" class="external-link">step_impute_median()</a></code> imputes missing values (since we will be doing a random forest model which cannot handle missing values). <code><a href="https://recipes.tidymodels.org/reference/step_YeoJohnson.html" class="external-link">step_YeoJohnson()</a></code> does a Yeo-Johnson transformation on the predictors, which makes them more symmetric and ‘<em>Gaussian</em>-like’. It also saves the parameters used in the transformation which will be automatically applied to any test data used for prediction later. Finally <code><a href="https://recipes.tidymodels.org/reference/step_normalize.html" class="external-link">step_normalize()</a></code> transforms predictors to have a mean of zero and a standard deviation of 1, so that they are all on the same scale. It also saves the means and sds to be applied to test data. To see the result of the step we run <code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep()</a></code> and <code>bake(new_data = NULL)</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdm_recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">step_add_env_vars</span><span class="op">(</span>env <span class="op">=</span> <span class="va">euro.worldclim</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_impute_median.html" class="external-link">step_impute_median</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_YeoJohnson.html" class="external-link">step_YeoJohnson</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_normalize.html" class="external-link">step_normalize</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">sdm_recipe</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test</span></span>
<span><span class="co">#&gt; # A tibble: 5,260 × 22</span></span>
<span><span class="co">#&gt;    present                 pnts pnt_origin   bio1    bio2   bio3     bio4</span></span>
<span><span class="co">#&gt;    &lt;fct&gt;            &lt;POINT [°]&gt; &lt;fct&gt;       &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 present (-5.171215 43.06957) data       -1.47   0.167   0.777 -0.332  </span></span>
<span><span class="co">#&gt;  2 present (-6.036635 43.02531) data       -1.53   0.167   0.777 -0.336  </span></span>
<span><span class="co">#&gt;  3 present (-7.679727 40.38852) data        1.07  -0.332  -0.193 -0.0434 </span></span>
<span><span class="co">#&gt;  4 present (-7.790437 40.30959) data        0.645 -0.763  -1.16  -0.0264 </span></span>
<span><span class="co">#&gt;  5 present  (-7.47334 43.78935) data        1.23  -1.44    1.76  -1.61   </span></span>
<span><span class="co">#&gt;  6 present  (-6.575039 42.9107) data       -1.28   0.0786  0.777 -0.248  </span></span>
<span><span class="co">#&gt;  7 present (-5.132756 43.49572) data        0.854 -1.35    1.27  -1.33   </span></span>
<span><span class="co">#&gt;  8 present (-7.787378 40.39362) data        1.07  -0.332  -0.193 -0.0434 </span></span>
<span><span class="co">#&gt;  9 present  (-4.941888 43.3531) data        0.593 -1.35    0.777 -1.27   </span></span>
<span><span class="co">#&gt; 10 present  (-7.621731 40.3417) data       -0.644 -1.44   -2.58   0.00321</span></span>
<span><span class="co">#&gt; # … with 5,250 more rows, and 15 more variables: bio5 &lt;dbl&gt;, bio6 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   bio7 &lt;dbl&gt;, bio8 &lt;dbl&gt;, bio9 &lt;dbl&gt;, bio10 &lt;dbl&gt;, bio11 &lt;dbl&gt;, bio12 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   bio13 &lt;dbl&gt;, bio14 &lt;dbl&gt;, bio15 &lt;dbl&gt;, bio16 &lt;dbl&gt;, bio17 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   bio18 &lt;dbl&gt;, bio19 &lt;dbl&gt;</span></span></code></pre></div>
<p>Now we can setup a random forest model with <a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a> and combine it with our recipe using a workflow from the <a href="https://github.com/tidymodels/workflows" class="external-link">workflows</a> package..</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html" class="external-link">rand_forest</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"ranger"</span>, importance <span class="op">=</span> <span class="st">"impurity"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html" class="external-link">set_mode</a></span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">sdm_recipe</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">mod</span>,</span>
<span>            formula <span class="op">=</span> <span class="va">present</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wf</span></span>
<span><span class="co">#&gt; ══ Workflow ════════════════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Recipe</span></span>
<span><span class="co">#&gt; Model: rand_forest()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; 4 Recipe Steps</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • step_add_env_vars()</span></span>
<span><span class="co">#&gt; • step_impute_median()</span></span>
<span><span class="co">#&gt; • step_YeoJohnson()</span></span>
<span><span class="co">#&gt; • step_normalize()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ───────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Random Forest Model Specification (classification)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Engine-Specific Arguments:</span></span>
<span><span class="co">#&gt;   importance = impurity</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: ranger</span></span></code></pre></div>
<p>Now we fit the model! We will start with the regular cross validation folds, and use <code>fit_resamples()</code> to generate metrics based on the fits to each of the validation sets in our folds. Then <code>collect_metrics()</code> will calculate the means across folds for us.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_1</span> <span class="op">&lt;-</span> <span class="va">wf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span><span class="va">cv_folds</span>, </span>
<span>                control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>extract <span class="op">=</span> <span class="va">extract_fit_engine</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 6</span></span>
<span><span class="co">#&gt;   .metric  .estimator  mean     n std_err .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary     0.948     9 0.00311 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary     0.824     9 0.0121  Preprocessor1_Model1</span></span></code></pre></div>
<p>Okay, so our ROC AUC value is pretty good at around 0.82. Now we do the same for the spatial cross validation folds.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_2</span> <span class="op">&lt;-</span> <span class="va">wf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span><span class="va">cv_folds_spat</span>,</span>
<span>                control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>extract <span class="op">=</span> <span class="va">extract_fit_engine</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; ! Fold6: internal: No control observations were detected in `truth` with control level 'pre...</span></span>
<span><span class="co">#&gt; ! Fold7: internal: No control observations were detected in `truth` with control level 'pre...</span></span>
<span></span>
<span><span class="va">fit_2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 6</span></span>
<span><span class="co">#&gt;   .metric  .estimator  mean     n std_err .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary     0.968     9  0.0127 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary     0.577     7  0.0541 Preprocessor1_Model1</span></span></code></pre></div>
<p>Using spatially independent cross validation folds has shown us our model does much more poorly if we ask it to generalise to spatial areas not in the training set. Now ROC AUC is only ~ 0.58 – considerably worse. Looking at the individual folds, there is substantial variation in the quality of models.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_2</span><span class="op">$</span><span class="va">.metrics</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary         0.955 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary         0.775 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary         0.991 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary         0.743 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary         0.989 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary         0.503 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary         0.983 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary         0.454 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[5]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary         0.984 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary         0.476 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[6]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary             1 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary            NA Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[7]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary             1 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary            NA Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[8]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary         0.919 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary         0.437 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[9]]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate .config             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1 accuracy binary         0.894 Preprocessor1_Model1</span></span>
<span><span class="co">#&gt; 2 roc_auc  binary         0.653 Preprocessor1_Model1</span></span></code></pre></div>
<p>The first fold the model looks to have done a reasonable job. Which one was that?</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">cv_folds_spat</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot_last_fold-1.png" width="100%"></p>
<p>Let’s have a look at the importance values determined by the random forest for our variables.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/koalaverse/vip/" class="external-link">vip</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'vip'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:utils':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     vi</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'patchwork'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:raster':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     area</span></span>
<span></span>
<span><span class="va">fit_1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">.extracts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">.extracts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">vip</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-importance-1.png" width="100%"></p>
<p>The ordering is reasonably consistent between different folds. Now, the spatial folds:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">.extracts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">.extracts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">vip</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-importance2-1.png" width="100%"></p>
<p>There seems to be quite a bit more variation in what variables are important between different spatial folds. Which is interesting.</p>
<p>We can try and improve the performance of the model on spatially independent data by using the spatial cross validation folds to tune the hyperparameters of the model. We can use the <a href="https://tune.tidymodels.org/" class="external-link">tune</a> package for this. Using <code>tune_bayes()</code> we can use Bayesian optimization to find an optimal set. What hyperparameters should we tune. For random forest we only have three, <code>mtry</code>, <code>trees</code>, and <code>min_n</code>. Let’s try tuning all three. First we make a new model object where we designate these parameters for tuning, then wrap it into a new workflow.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_tune</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html" class="external-link">rand_forest</a></span><span class="op">(</span>mtry <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        trees <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        min_n <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"ranger"</span>, importance <span class="op">=</span> <span class="st">"impurity"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html" class="external-link">set_mode</a></span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wf_tune</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">sdm_recipe</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">mod_tune</span>,</span>
<span>            formula <span class="op">=</span> <span class="va">present</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wf_tune</span></span>
<span><span class="co">#&gt; ══ Workflow ════════════════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Recipe</span></span>
<span><span class="co">#&gt; Model: rand_forest()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; 4 Recipe Steps</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • step_add_env_vars()</span></span>
<span><span class="co">#&gt; • step_impute_median()</span></span>
<span><span class="co">#&gt; • step_YeoJohnson()</span></span>
<span><span class="co">#&gt; • step_normalize()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ───────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Random Forest Model Specification (classification)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Main Arguments:</span></span>
<span><span class="co">#&gt;   mtry = tune()</span></span>
<span><span class="co">#&gt;   trees = tune()</span></span>
<span><span class="co">#&gt;   min_n = tune()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Engine-Specific Arguments:</span></span>
<span><span class="co">#&gt;   importance = impurity</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: ranger</span></span></code></pre></div>
<p>Tuning is now as simple as calling <code>tune_bayes()</code>. First we set up an initial set of tuning models using a tuning grid (regularly spaced values of the hyper-parameters). By the way, this will take awhile. If you want to do this on your computer I would recommend setting up a parallel backend for tuning (see <a href="https://tune.tidymodels.org/articles/extras/optimizations.html" class="external-link uri">https://tune.tidymodels.org/articles/extras/optimizations.html</a>).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tune_init</span> <span class="op">&lt;-</span> <span class="va">wf_tune</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">tune_grid</span><span class="op">(</span><span class="va">cv_folds_spat</span>,</span>
<span>            grid <span class="op">=</span> <span class="fl">27</span>,</span>
<span>            control <span class="op">=</span> <span class="fu">control_grid</span><span class="op">(</span>verbose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now this serves as initial values for <code>tune_bayes()</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_parameter_set_dials</a></span><span class="op">(</span><span class="va">mod_tune</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">finalize</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tuned</span> <span class="op">&lt;-</span> <span class="va">wf_tune</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">tune_bayes</span><span class="op">(</span><span class="va">cv_folds_spat</span>,</span>
<span>             initial <span class="op">=</span> <span class="va">tune_init</span>,</span>
<span>             iter <span class="op">=</span> <span class="fl">50</span>,</span>
<span>             param_info <span class="op">=</span> <span class="va">final_params</span>,</span>
<span>             control <span class="op">=</span> <span class="fu">control_bayes</span><span class="op">(</span>verbose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                     no_improve <span class="op">=</span> <span class="fl">50L</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tuned</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">show_best</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>After all that we haven’t much improved the ability of our model to predict spatially separated testing data sets! This is not that surprising since random forest generally doesn’t need much tuning. And ultimately, the problem is not poor hyper-parameters but overfitting to spatial patterns found in the data. This cannot be prevented except by finding some way to help the model ‘account’ for spatial autocorrelation in the data. There are some approaches to doing this, which might help, but can only go so far. The problem of space is impossible to make go away completely, at least using statistical methods.</p>
<p>Note that the best solutions had a very low <code>mtry</code>. This means the random forest is only using 1 to 3 variables at a time to make predictions. This implies all variable contain mostly the same amount of information and don’t interact much, suggesting that these climate predictors have little to do with the species distribution, each is mainly being used for their spatial information. The best bet here, as in most cases is to find better predictors that are more definitely related to the species’ known ecology!</p>
<p>Lastly, <a href="https://rdinnager.github.io/tidysdm/">tidysdm</a> makes it easy to generate visualizable predictions on the original landscape using the <code><a href="reference/create_prediction_grid.html">create_prediction_grid()</a></code> function, which creates a grid of x and y values, optionally with a polygon attached to help with plotting. Feeding this to the <code>augment</code> function will automatically make predictions based on the model and the bind those prediction back to the prediction grid data, ready for plotting. We will make hexagons which look much cooler than squares (just use <code>square = FALSE</code>).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/create_prediction_grid.html">create_prediction_grid</a></span><span class="op">(</span>bg <span class="op">=</span> <span class="va">monticola</span><span class="op">$</span><span class="va">range</span>, n <span class="op">=</span> <span class="fl">2500</span>, square <span class="op">=</span> <span class="cn">FALSE</span>, include_polygons <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pred_grid</span><span class="op">$</span><span class="va">polygon</span><span class="op">)</span></span></code></pre></div>
<p>Now to make the predictions we first do a final fit of our random forest model on the full data set, and using the best hyper-parameters from our spatial cross validation.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_fit</span> <span class="op">&lt;-</span> <span class="va">wf_tune</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">finalize_workflow</span><span class="op">(</span><span class="fu">select_best</span><span class="op">(</span><span class="va">tuned</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">final_fit</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Does not work yet</span></span>
<span><span class="va">pred_grid_preds</span> <span class="op">&lt;-</span> <span class="va">final_fit</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">pred_grid</span><span class="op">)</span></span>
<span> </span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing tidysdm</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Russell Dinnage <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0003-0846-2819" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/rdinnager/tidysdm/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/rdinnager/tidysdm/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Russell Dinnage.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
